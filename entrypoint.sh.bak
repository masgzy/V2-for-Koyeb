#!/usr/bin/env bash

# 定义 UUID 及伪装路径,请自行修改
base64 -d config > config.json
UUID=${UUID:-'de04add9-5c68-8bab-950c-08cd5320df18'}
VMESS_WSPATH=${VMESS_WSPATH:-'/vmess'}
VLESS_WSPATH=${VLESS_WSPATH:-'/vless'}
sed -i "s#UUID#$UUID#g;s#VMESS_WSPATH#${VMESS_WSPATH}#g;s#VLESS_WSPATH#${VLESS_WSPATH}#g" config.json
sed -i "s#VMESS_WSPATH#${VMESS_WSPATH}#g;s#VLESS_WSPATH#${VLESS_WSPATH}#g" /etc/nginx/nginx.conf

# 伪装 v2ray 执行文件
RELEASE_RANDOMNESS=$(tr -dc 'A-Za-z0-9' </dev/urandom | head -c 6)
mv v ${RELEASE_RANDOMNESS}
cat config.json | base64 > config
rm -f config.json

# 哪吒监控安装部分（保持您的URL，只修正变量名）
TLS=${NEZHA_TLS:+'--tls'}
if [ -n "${NEZHA_SERVER}" ] && [ -n "${NEZHA_PORT}" ] && [ -n "${NEZHA_KEY}" ] && [ -n "${NEZHA_UUID}" ]; then
    curl -L https://raw.githubusercontent.com/nezhahq/scripts/main/agent/install.sh -o agent.sh
    chmod +x agent.sh
    env NZ_SERVER="${NEZHA_SERVER}:${NEZHA_PORT}" NZ_TLS="${NEZHA_TLS}" NZ_CLIENT_SECRET="${NEZHA_KEY}" NZ_UUID="${NEZHA_UUID}" ./agent.sh
    rm -f agent.sh
fi

# 运行 nginx 和 v2ray
nginx
base64 -d config > config.json
./${RELEASE_RANDOMNESS} run
